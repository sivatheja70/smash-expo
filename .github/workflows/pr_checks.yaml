name: Code Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  audit-deps:
    runs-on: ubuntu-latest
     
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4.0.2
      with:
        node-version: "18"

    - name: Audit Dependencies
      id: audit_dependencies
      run: npm audit --production --audit-level=moderate

    # - name: Set Audit Status
    #   if: always()
    #   uses: actions/github-script@v5
    #   with:
    #     github-token: ${{ secrets.GITHUB_TOKEN }}
    #     script: |
    #        try {
    #          console.log('Context:', context); // Log the context object  
    #          github.repos.createStatus({
    #          owner: context.repo.owner,
    #          repo: context.repo.repo,
    #          sha: context.sha,
    #          state: 'failure',
    #          description: 'Audit Dependencies',
    #          context: 'Audit Dependencies'
    #         });
    #        } catch (error) {
    #         console.error('Error setting audit status:', error);
    #        }

    # - name: Set Audit Status
    #   if: always()
    #   uses: actions/github-script@v5
    #   with:
    #     github-token: ${{ secrets.GIT_TOKEN }}
    #     script: |
    #       github.repos.createStatus({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         sha: context.sha,
    #         state: '${{ job.status }}',
    #         description: 'Audit Dependencies',
    #         context: 'Audit Dependencies'
    #       })

  unit-test:
    runs-on: ubuntu-latest
    needs: [audit-deps]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4.0.2
      with:
        node-version: "18.x"

    - name: Installing Dependencies
      run: npm ci

    - name: Unit Test
      id: test_unit
      run: npm test

    # - name: Set Unit Test Status
    #   if: always()
    #   uses: actions/github-script@v5
    #   with:
    #     github-token: ${{ secrets.GIT_TOKEN }}
    #     script: |
    #       github.repos.createStatus({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         sha: context.sha,
    #         state: '${{ job.status }}',
    #         description: 'Unit Test',
    #         context: 'Unit Test'
    #       })

  lint-code:
    runs-on: ubuntu-latest
    needs: [audit-deps]
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4.0.2
      with:
        node-version: "18"

    - name: Installing Dependencies
      run: npm ci

    - name: Lint Source
      id: lint_source
      run: npm run lint

    # - name: Set Lint Status
    #   if: always()
    #   uses: actions/github-script@v5
    #   with:
    #     github-token: ${{ secrets.GIT_TOKEN }}
    #     script: |
    #       github.repos.createStatus({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         sha: context.sha,
    #         state: '${{ job.status }}',
    #         description: 'Lint Source',
    #         context: 'Lint Source'
    #       })
